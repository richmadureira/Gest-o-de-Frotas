<!-- 7d217375-3096-4383-b0e1-1967753863cc 73601b02-6641-4d4a-aa8e-c8c26e6405ef -->
# Plano: Melhorias em Manutenções SAP

## Frontend (packages/frontend/src/pages/MaintenanceSAP.tsx)

- Reordenar e travar campos no diálogo “Nova Manutenção SAP”:
  - Campo Veículo primeiro (obrigatório). Após selecionar, buscar o veículo (`GET /veiculos/{id}`) e auto-preencher `quilometragemNoAto` com `Veiculo.Quilometragem`. Os demais campos ficam desabilitados até haver `veiculoId` válido.
  - Campo Quilometragem como segundo campo, preenchido automaticamente e desabilitado (somente leitura, sem ajuste manual).
- Remover do formulário e validação: "Agendar Para", "Centro de Custo", "Observações".
- Ajustar validação obrigatória: `veiculoId`, `tipo`, `prioridade`, `descricao`, `quilometragemNoAto`.
- Atualizar payload em `createManutencao` para enviar apenas: `veiculoId`, `tipo`, `prioridade`, `quilometragemNoAto`, `descricao`, `custo?`.
- Atualizar tabela:
  - Substituir uso de `progresso` do backend por cálculo client-side com base em `statusSAP` (ex.: Solicitada 0%, Aprovada 10%, EnviadaSAP 25%, ProcessandoSAP 50%, OrdemCriada 70%, EmExecucao 85%, Finalizada 100%).
  - Remover dependência de campos removidos no backend.

### Trecho essencial (auto-KM, ilustrativo)

```typescript
// após selecionar veículo
const { data } = await getChecklists({ veiculoId });
const ultimo = data?.[0]; // API já ordena por Data desc
setFormData(f => ({ ...f, veiculoId, quilometragemNoAto: ultimo?.kmVeiculo?.toString() || '' }));
```

## Serviços (packages/frontend/src/services/api.ts)

- Ajustar `createManutencao(...)` para novo contrato.
- Adicionar helper `getChecklists({ veiculoId })` já existente para reutilização na busca da KM.

## Backend

### Modelo (packages/backend/src/GestaoFrotas.Domain/Entities/Manutencao.cs)

- Remover campos: `Status`, `AgendadoPara`, `Progresso`, `CentroCusto`, `Observacoes`.
- Manter/adotar campos: `VeiculoId`, `Tipo`, `Descricao`, `Custo?`, `StatusSAP?`, `NumeroOrdemSAP?`, `FornecedorSAP?`, `Prioridade`, `QuilometragemNoAto?`, `ConcluidoEm?`, `SolicitanteId?`.

### Controller (packages/backend/src/GestaoFrotas.API/Controllers/ManutencoesController.cs)

- Ajustar DTOs de criação/edição para refletir o novo contrato (sem AgendadoPara/Observações/CentroCusto/Status/Progresso).
- Status de fluxo via `StatusSAP` apenas; expor endpoint de simulação já existente e de atualização se necessário.

### Configuração/EF (packages/backend/src/GestaoFrotas.Infrastructure)

- Atualizar `Configurations/ManutencaoConfiguration.cs` conforme novos campos.
- Criar migration para:
  - Dropar colunas: `Status`, `AgendadoPara`, `Progresso`, `CentroCusto`, `Observacoes`.
  - Garantir `Prioridade` e `QuilometragemNoAto` existentes (com defaults). 

### Seed (packages/backend/src/GestaoFrotas.Infrastructure/Data/DataSeeder.cs)

- Popular manutenções com todos os campos necessários e `StatusSAP` inicial `Solicitada`, `Prioridade` = `Media`, `QuilometragemNoAto` coerente, `Custo?` opcional.

## Compatibilidade de Dados e UI

- Mapear barra de progresso no front a partir de `StatusSAP` (já que `Progresso` será removido do banco).
- Ajustar lista/DTO para não esperar campos removidos.

### To-dos

- [ ] Refatorar diálogo em `MaintenanceSAP.tsx`: ordem de campos, auto-KM, remover campos
- [ ] Atualizar tabela: progresso calculado via `statusSAP`, remover dependências antigas
- [ ] Atualizar `createManutencao` no `services/api.ts` para novo payload
- [ ] Remover campos obsoletos de `Manutencao` e manter StatusSAP/Prioridade/KM
- [ ] Ajustar `ManutencoesController` DTOs e lógica conforme novo modelo
- [ ] Atualizar configuration e criar migration para dropar colunas antigas
- [ ] Atualizar `DataSeeder` com registros completos e `StatusSAP` inicial